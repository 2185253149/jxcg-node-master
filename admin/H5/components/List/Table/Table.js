!function(e){var t=new e.Picker;window.components_List_Table_Table({component:!0,usingComponents:{mixinput:"/components/Input/Mixinput/Mixinput"}},{template:"#TEMPLATE_components_List_Table_Table",props:{},data:function(){return{oid:"",searchValues:{pageSize:10,pageNum:1},searchValuesShow:[{}],models:{},searchs:[],rows:[],total:0,allChecked:!1,pagination:[],actions:[],getUrl:"",canDelete:"",idKey:"",deleteKey:"id",canCheck:!0,canBack:!1,exportUrl:"",canAdd:!1,textstitle:"",textstitleStyle:"",statistics:"",statisticsString:"",rowspan:"",rowspans:{},textssearchBtn:"搜索",textsaddBtn:"新增",textseditBtn:"编辑",textsbackBtn:"返回",textsexportBtn:"导出",textsoutEditBtn:"退出编辑",textsdeletsBtn:"批量删除",textsallCheckBtn:"全选",textsunAllCheckBtn:"反选",textscheckBtn:"选择"}},methods:{showTip:function(t){e.alertx(t)},exportExcel:function(a){var s=this.getData("exportUrl"),i=this.getData("searchValues");if(s)if("action"==s){var n=e.Storage.get(this.oid);n.export&&"function"==typeof n.export.action&&n.export.action.call(this,{type:"export",event:a,detail:i})}else i.createTime?r():t.pick({items:[{name:"前一周",value:7},{name:"前一月",value:31},{name:"前一季度",value:93},{name:"前半年",value:180},{name:"前一年",value:365}],title:"选择时间",pickBox:`right:32px;left:auto;top:${a.pageY}px`,index:1},e=>{e.data&&e.data.value&&(i.createTime=JSON.stringify({$gte:(new Date).getTime()-24*e.data.value*60*60*1e3}),r())});function r(){0!=(s=s.replace(new RegExp("^{(.+)}","g"),function(t,a){return e.Storage.get(a)||"{"+a+"}"})).indexOf("http")&&(s=e.Storage.get("APIURL")+s);for(var t=e.Storage.get("ajaxHeader"),a=[],n=0;n<t.length;n++)a.push(t[n].key+"="+t[n].value);for(var r in i)"pageSize"!=r&&"pageNum"!=r&&a.push(r+"="+i[r]);e.showFile(s+(s.indexOf("?")>-1?"&":"?")+a.join("&"),!1,"excel")}},computPagination:function(){for(var e=Math.ceil(this.total/this.searchValues.pageSize),t=[{name:"<",value:"prev",unClick:1==this.searchValues.pageNum}],a=!1,s=!1,i=0;i<e;i++)0==i||i==e-1?t.push({name:i+1,value:i+1,isActive:this.searchValues.pageNum==i+1}):i+1-this.searchValues.pageNum<-2?a||(a=!0,t.push({name:"...",value:"prevmore"})):i+1-this.searchValues.pageNum>2?s||(s=!0,t.push({name:"...",value:"nextmore"})):t.push({name:i+1,value:i+1,isActive:this.searchValues.pageNum==i+1});t.push({name:">",value:"next",unClick:this.searchValues.pageNum==e}),this.setData({pagination:t.length>3?t:[]})},pageChange:function(e){if(e.unClick||e.isActive)return!1;switch(e.value){case"prev":this.searchValues.pageNum--;break;case"next":this.searchValues.pageNum++;break;case"prevmore":this.searchValues.pageNum-=3;break;case"nextmore":this.searchValues.pageNum+=3;break;default:this.searchValues.pageNum=e.value}this.load()},change:function(e){var t=e.detail.value;t||0===t||"0"===t||"0"===t||(t=void 0),this.searchValues[e.detail.id]=t,this.searchValuesShow.splice(0,1),this.searchValuesShow.push(this.searchValues)},filter:function(t,a){var s=e.Storage.get(this.oid+"edit"),i="",n=this.models[a];if(n&&("function"==typeof n.model?n=n.model.call(this,t,n)||n:"object"==typeof n.model&&n.model&&(n=n.model)),!n)return["",""];switch(n.type){case"radio":case"select":for(var r=0;r<n.attr.actions.length;r++)if(t[a]==n.attr.actions[r].value){i=n.attr.actions[r].name;break}break;case"checkbox":i=[];for(r=0;r<n.attr.actions.length;r++)new RegExp(","+n.attr.actions[r].value+",").test(","+t[a]+",")&&i.push(this.models[a].attr.actions[r].name);i=i.join(",");break;case"datetime":i=t[a]?e.date(- -t[a]).toLocalString():"";break;case"switch":i=s[a]?1==t[a]:1==t[a]?"是":"否";break;case"image":return i="/"===(i="string"==typeof t[a]?t[a].split(",")[0]:"").charAt(0)?e.Storage.get("APIURL")+i:i;case"file":i=(i=e.string(t[a]).parse([])[0])&&i.originalname?i.originalname:"";break;case"onlyselect":i=t[a.replace("Id","")+n.attr.skey.replace(/([A-Za-z])/,function(e,t){return t.toUpperCase()})]||t[a];break;default:if(i=t[a],/input|textarea/.test(n.type)||!n.type){let e=n.attr&&n.attr.stringmax?n.attr.stringmax:16;i=["string"==typeof i&&i.length>e?i.substring(0,e)+"...":i,i]}}return i},check:function(e){if(e>-1)this.rows[e].checked=!this.rows[e].checked;else{this.allChecked=!this.allChecked;for(var t=0;t<this.rows.length;t++)this.rows[t].checked=this.allChecked}},selected:function(){for(var e=[],t=0;t<this.rows.length;t++)this.rows[t].checked&&e.push(this.rows[t]);return e},doAction:function(t,a,s){var i=e.Storage.get(this.oid);if(i[t])switch(t){case"delet":this.delet.call(this,a);break;default:i[t]&&"function"==typeof i[t].action&&i[t].action.call(this,{type:t,event:s,detail:e.clone(this.rows[a])})}},add:function(t){var a=e.Storage.get(this.oid);a.add&&"function"==typeof a.add.action&&a.add.action.call(this,{type:"add",event:t,detail:{}})},editList:function(t,a,s){var i=e.Storage.get(this.oid+"edit"),n=this,r={id:s.id};r[a.id]=t.detail.value,"switch"==a.type&&(r[a.id]=r[a.id]?1:0),"string"==typeof i[a.id]?e.ajax(i[a.id],function(t){n.load(),e.alertx("修改 "+a.label+(t.errorMsg?" 失败,"+t.errorMsg:" 成功!"))},{data:r,meth:"PUT"}):"function"==typeof i[a.id]&&i[a.id].call(this,r)},delet:function(t){var a=e.Storage.get(this.oid),s=[],i=this;if(t>-1)s.push(this.rows[t][this.deleteKey]);else for(var n=0;n<this.rows.length;n++)this.rows[n].checked&&s.push(this.rows[n][this.deleteKey]);s.length?e.confirmx("确定要对此"+s.length+"项进行删除?",function(){var t={};t[i.deleteKey]={$in:s},"string"==typeof a.delet.action?e.ajax(a.delet.action,function(t){e.alertx(t.errorMsg||"删除成功!!"),t.errorMsg||i.refresh()},{meth:"DELETE",data:t}):"function"==typeof a.delet.action&&a.delet.action.call(i,{type:"delete",detail:t})}):e.alertx("请选择需要删除的项")},val:function(e){if(void 0==e)return this.selected();for(var t=0;t<this.rows.length;t++)e[this.rows[t][this.idKey]]&&(this.rows[t].checked=!0)},getRows:function(){return this.rows},refresh:function(e){this.searchValues.pageNum=1,this.load(e)},load:function(t){var a=this.getData("getUrl"),s=a,i={},n="GET",r=!0,o=!1,l=this.getData("rowspan");"object"==typeof a&&(a.data&&(i=a.data),a.url&&(s=a.url),a.meth&&(n=a.meth),!1===a.dataJson&&(r=!1),a.urlQuery&&(o=!0));for(var c=this.getData("models"),h=0;h<this.searchs.length;h++)c[this.searchs[h].id]=this.searchs[h];for(var u in this.searchValues){if(i[u]=this.searchValues[u],c[u]&&"onlyselect"==c[u].type){var d=e.string(this.searchValues[u]).parse({}),p=c[u].attr.vkey||"id";i[u]=d[p]?"unitId"==u?{$regex:d[p]}:d[p]:void 0}else if(c[u]&&"datetime"==c[u].type&&void 0!=i[u]){if(/END$/.test(u))continue;this.searchValues[u+"END"]?i[u]={$gte:this.searchValues[u],$lte:this.searchValues[u+"END"]}:i[u]={$gte:this.searchValues[u]}}else!c[u]||/select|date|time/.test(c[u].type)||void 0==i[u]||c[u].unRegex||(i[u]={$regex:this.searchValues[u]});""===i[u]&&(i[u]=void 0)}function g(e){if(l)for(var t="",a=0;a<e.length;a++)"function"==typeof m.addDataChange&&m.addDataChange.call(e[a],e[a],a),t&&t[l]==e[a][l]?(t.rowspan++,e[a].rowspan=""):(e[a].rowspan=1,t=e[a]);else if("function"==typeof m.addDataChange)for(a=0;a<e.length;a++)m.addDataChange.call(e[a],e[a],a)}var f=this,m=e.Storage.get(this.oid);s instanceof Array?new e.SQLite(s).find(i,function(t){g(t.rows),f.setData({rows:t.rows,total:t.total,allChecked:!1,statisticsString:e.string(f.getData("statistics"))._eval(t)})},{pageNum:this.searchValues.pageNum,pageSize:this.searchValues.pageSize}):e.ajax(s,function(a){a.errorMsg?f.setData({rows:[],allChecked:!1,pageTotal:1,statisticsString:""}):(g(a.rows),f.setData({rows:a.rows,total:a.total,allChecked:!1,statisticsString:e.string(f.getData("statistics"))._eval(a)})),f.computPagination(),"function"==typeof t&&t.call({res:a})},{data:i,meth:n,dataJson:r,urlQuery:o})},init:function(t){var a=[];t.actions=t.actions||{},t.oid=t.oid||e.zIndex();var s,i={};for(var n in s=t.edit||{},t.actions)if(i[n]=t.actions[n],i[n])if("add"==n&&i[n])t.canAdd=!0;else if("export"!=n){if("delet"==n){if(!i[n])continue;t.canDelete=!0,t.actions[n].className="danger "+(t.actions[n].className||"")}else if("edit"==n){if(!i[n])continue;t.actions[n].className="primary "+(t.actions[n].className||"")}a.push({action:n,name:t.actions[n].name,style:t.actions[n].style||"",className:"button mini "+(t.actions[n].className||"")})}else t.exportUrl="action",t.textsexportBtn=i[n].name;if(i.addDataChange=t.addDataChange,e.Storage.set(t.oid,i),e.Storage.set(t.oid+"edit",s),t.actions=a,t.searchKey){for(var r=t.searchKey?t.searchKey.split(","):[],o=t.searchs||[],l=e.clone(this.searchValues),c=0;c<r.length;c++){var h={};"unitId"==r[c]?h={id:"unitId",label:"所属"+(e.Storage.get("nickNames").unit||"单位"),attr:{skey:"name",vkey:"unitId",url:"/api/model/unit",canClear:!0,title:"请选择"+(e.Storage.get("nickNames").unit||"单位")},type:"onlyselect"}:t.models[r[c]]&&(h=e.clone(t.models[r[c]])),h&&"checkbox"!=h.type&&("radio"==h.type&&(h.type="select"),"switch"==h.type&&(h.type="select",h.attr=h.attr||{},h.attr.actions=[{name:"否",value:0},{name:"是",value:1}]),"textarea"==h.type&&(h.type="input"),h.attr=h.attr||{},h.attr.placeholder=h.label,l[r[c]]=h.defaultValue,"select"==h.type&&h.attr.actions.unshift({name:"全部",value:""}),h.id=h.id||r[c],h.type=h.type||"input",o.push(h))}t.searchs=o,t.searchValues=l,t.searchValuesShow=[l]}this.setData(t)}}})}(Y);