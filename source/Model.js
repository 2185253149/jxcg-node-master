var DB=require("./SQLHelper"),$=require("./tool");function Model(t,e,i){this.name=t,this.idKey=i||"id",this.desc=e.TABLE_DESC||"",this.nickName=e.TABLE_NICK_NAME||"",delete e.TABLE_DESC,delete e.TABLE_NICK_NAME,this.schemas=e;const s=/(and|or|exec|insert|select|update|count|\*|%|chr|mid|master|truncate|char|declare|delete|create|drop)\s/;this.checkSQL=function(t,e){try{if("string"!=typeof t)return t;if(e)return s.test(t)?t.replace(s,""):/^\{.+\}$/.test(t)?JSON.parse(t):t;if(!s.test(t))return t}catch(t){return e?"----------":""}},this.queryFormat=function(t){t=t||{};var e={};for(var i in this.schemas){var s=this.schemas.unCheckSQL?t[i]:this.checkSQL(t[i],!0);void 0!==s&&""!==s&&(e[i]=s)}if(t.pageNum&&(e.pageNum=t.pageNum),t.pageSize&&(e.pageSize=t.pageSize),t.unitId&&this.schemas.unitId){var r=this.checkSQL(t.unitId,!0);r&&(e.unitId=r)}return e},this.find=function(t,e,i){return DB.find(this.name,this.queryFormat(t),e,i)},this.findSync=function(t,e){return new Promise(i=>{this.find(t,i,e)})},this.findDB=function(t,e,i,s){return DB.find(this.name,this.queryFormat(e),i,s,t)},this.list=function(t,e,i){return void 0==t.state&&(t.state=1),!(i=i||{}).sort&&this.schemas.id&&(i.sort={},i.sort[this.name+".id"]=-1),DB.list(this.name,this.queryFormat(t),e,i)},this.listSync=function(t,e){return new Promise(i=>{this.list(t,i,e)})},this.listDB=function(t,e,i,s){return void 0==e.state&&(e.state=1),!(s=s||{}).sort&&this.schemas.createTime&&(s.sort={},s.sort[(this.name||t)+".createTime"]=-1),DB.list(this.name,this.queryFormat(e),i,s,t)},this.functions=function(t,e,i,s){return DB.functions(this.name,t,e,this.queryFormat(i),s)},this.functionsSync=function(t,e,i){return new Promise(s=>{this.functions2(t,s,e,i)})},this.functionsDB=function(t,e,i,s,r){return DB.functions(this.name,e,i,this.queryFormat(s),r,t)},this.dataFormat=function(t,e){var i={},s=[];for(var r in e?t:this.schemas){if("_id"==r);else if("unitId"==r&&void 0!=t[r]&&null!=t[r])i[r]="string"!=typeof t[r]||this.schemas[r].unCheckSQL?t[r]:this.checkSQL(t[r]);else if("id"==r&&e);else if(e&&void 0==t[r]);else if(this.schemas[r]&&(this.schemas[r],1)&&("string"==typeof t[r]&&(t[r]=this.schemas[r].unCheckSQL?t[r]:this.checkSQL(t[r])),void 0==t[r]||null==t[r]?void 0!=this.schemas[r].defaultValue&&(i[r]=this.schemas[r].defaultValue):i[r]=t[r],this.schemas[r].rule))if(this.schemas[r].rule.NotNull||$.Verify.NotNull(i[r])[0])for(var n in this.schemas[r].rule){var a=this.schemas[r].rule[n];if(0!=a){var u=$.Verify[n](i[r],a);u[0]||s.push(this.schemas[r].label+u[1])}}else;this.schemas[r]&&((/^(sort|state|level|createTime|updateTime)$/.test(r)||"switch"==this.schemas[r].type||this.schemas[r].data_type&&this.schemas[r].data_type.indexOf("INT")>-1||this.schemas[r].attr&&"number"==this.schemas[r].attr.type||this.schemas[r].rule&&(this.schemas[r].rule.PositiveInt||this.schemas[r].rule.PositiveNum))&&"string"==typeof i[r]&&(i[r]=- -i[r]))}return 0==s.length?i:{errorMsg:s.join(",")}},this.insert=function(t,e,i){t.id=t.id?t.id:$.snowflake(),t=this.dataFormat(t);let s=new Date;if(t.createTime=t.createTime?t.createTime:s.getTime(),t.createTimeString=$.date(s).toLocalString(),t.state=1,Config&&Config.unitId&&!t.unitId&&(t.unitId=Config.unitId),!t.errorMsg)return DB.insert(this.name,t,"function"==typeof e?function(i){i.errorMsg?e(i):(t.id=t.id,e(t))}:e);"function"==typeof e&&e(t)},this.insertSync=function(t,e){return new Promise(i=>{this.insert(t,i,e)})},this.insertDB=function(t,e,i,s){(e=this.dataFormat(e)).id=e.id?e.id:$.snowflake();let r=new Date;if(e.createTime=e.createTime?e.createTime:r.getTime(),e.createTimeString=$.date(r).toLocalString(),e.state=1,Config&&Config.unitId&&!e.unitId&&(e.unitId=Config.unitId),!e.errorMsg)return DB.insert(this.name,e,"function"==typeof i?function(t){t.errorMsg?i(t):(e.id=e.id.toString(),i(e))}:i,t);"function"==typeof i&&i(e)},this.emptyQuery=function(t){var e=!0;for(var i in t)if(t[i]){e=!1;break}return e},this.update=function(t,e,i,s){if(!(e=this.emptyQuery(t)?{errorMsg:"不能进行无条件更新!"}:this.dataFormat(e,!0)).errorMsg){let r=new Date;return e.updateTime=e.updateTime?e.updateTime:r.getTime(),e.updateTimeString=$.date(r).toLocalString(),delete e.id,DB.update(this.name,this.queryFormat(t),e,i,s)}"function"==typeof i&&i(e)},this.updateSync=function(t,e,i){return new Promise(s=>{this.update(t,e,s,i)})},this.updateDB=function(t,e,i,s,r){if(!(i=this.emptyQuery(e)?{errorMsg:"不能进行无条件更新!"}:this.dataFormat(i,!0)).errorMsg){let n=new Date;return i.updateTime=i.updateTime?i.updateTime:n.getTime(),i.updateTimeString=$.date(n).toLocalString(),delete i.id,DB.update(this.name,this.queryFormat(e),i,s,r,t)}"function"==typeof s&&s(i)},this.remove=function(t,e,i){if(this.emptyQuery(t)){var s={errorMsg:"不能进行无条件删除!"};return"function"==typeof e&&e(s),s}return i&&i.real?DB.remove(this.name,this.queryFormat(t,!0),e,i):DB.update(this.name,this.queryFormat(t,!0),{state:0},e,i)},this.removeSync=function(t,e){return new Promise(i=>{this.remove(t,i,e)})},this.removeDB=function(t,e,i,s){if(this.emptyQuery(e)){var r={errorMsg:"不能进行无条件删除!"};return"function"==typeof i&&i(r),r}return(s=s||{}).real?DB.remove(this.name,this.queryFormat(e,!0),i,s,t):DB.update(this.name,this.queryFormat(e,!0),{state:0},i,s,t)}}module.exports=Model;